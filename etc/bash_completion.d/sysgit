#!/bin/bash

_sysgit_config_value() {
  local key="${1}"
  local config="${2}"

  awk -F= -v key="${key}" '
    $0 ~ "^[[:space:]]*"key"[[:space:]]*=" {
      val=$2
      sub(/^[[:space:]]+/, "", val)
      gsub(/[\"\047]/, "", val)
      sub(/[[:space:]]+$/, "", val)
      print val
    }' "${config}" | tail -n1
}

_sysgit_get_config() {
  local config="/etc/sysgit.conf"
  local i

  for ((i=1; i<${#COMP_WORDS[@]}; i++)); do
    if [[ "${COMP_WORDS[i]}" == "-c" && -n "${COMP_WORDS[i+1]}" ]]; then
      config="${COMP_WORDS[i+1]}"
    fi
  done

  echo "${config}"
}

_sysgit_profiles() {
  local cur="${1}"
  local profile_file="/var/lib/sysgit/sysgit.profile"
  local config="$(_sysgit_get_config)"
  local cfg_profile=""

  if [[ -r "${config}" ]]; then
    cfg_profile="$(_sysgit_config_value "MULTI_GIT_COMMITTER_PROFILE" "${config}")"
    if [[ -n "${cfg_profile}" ]]; then
      profile_file="${cfg_profile}"
    fi
  fi

  if [[ -r "${profile_file}" ]]; then
    COMPREPLY=( $(compgen -W "$(awk -F'|' 'NF{print $1}' "${profile_file}")" -- "${cur}") )
  else
    COMPREPLY=()
  fi
}

_sysgit_git_subcommand() {
  local i skip_next=0

  for ((i=1; i<${#COMP_WORDS[@]}; i++)); do
    if ((skip_next)); then
      skip_next=0
      continue
    fi
    case "${COMP_WORDS[i]}" in
      -c|-p)
        skip_next=1
        ;;
      -u|-h|-apt|-autocommit)
        ;;
      *)
        echo "${COMP_WORDS[i]}"
        return 0
        ;;
    esac
  done
}

_sysgit() {
  local cur prev words cword

  if ! declare -F _init_completion >/dev/null; then
    return
  fi

  _init_completion -n : || return

  case "${prev}" in
    -c)
      _filedir
      return
      ;;
    -p)
      _sysgit_profiles "${cur}"
      return
      ;;
  esac

  if [[ "${cur}" == -* ]]; then
    COMPREPLY=( $(compgen -W "-apt -autocommit -c -p -u -h" -- "${cur}") )
    return
  fi

  if declare -F __git_main >/dev/null; then
    local i skip_next=0
    local new_words=("git")
    local saved_words=("${COMP_WORDS[@]}")
    local saved_cword="${COMP_CWORD}"
    local config="$(_sysgit_get_config)"
    local sysgit_dir="/var/lib/sysgit"
    local work_tree="/"
    local cfg_dir=""
    local subcmd="$(_sysgit_git_subcommand)"

    for ((i=1; i<${#COMP_WORDS[@]}; i++)); do
      if ((skip_next)); then
        skip_next=0
        continue
      fi
      case "${COMP_WORDS[i]}" in
        -c|-p)
          skip_next=1
          ;;
        -u|-h|-apt|-autocommit)
          ;;
        *)
          new_words+=("${COMP_WORDS[i]}")
          ;;
      esac
    done

    if [[ -r "${config}" ]]; then
      cfg_dir="$(_sysgit_config_value "SYSGIT_DIR" "${config}")"
      if [[ -n "${cfg_dir}" ]]; then
        sysgit_dir="${cfg_dir}"
      fi
    fi

    if [[ "${subcmd}" == "add" && "${cur}" == /* ]]; then
      _filedir
      return
    fi

    COMP_WORDS=("${new_words[@]}")
    COMP_CWORD=$(( ${#COMP_WORDS[@]} - 1 ))
    GIT_DIR="${sysgit_dir}" GIT_WORK_TREE="${work_tree}" __git_main
    COMPREPLY+=( $(compgen -W "ignore" -- "${cur}") )

    COMP_WORDS=("${saved_words[@]}")
    COMP_CWORD="${saved_cword}"
  fi
}

complete -F _sysgit sysgit
